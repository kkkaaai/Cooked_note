generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents     Document[]
  annotations   Annotation[]
  folders       Folder[]
  conversations Conversation[]
  subscription  Subscription?
  usageRecords  UsageRecord[]
}

model Subscription {
  id                 String    @id @default(uuid())
  userId             String    @unique
  provider           String // "stripe" | "revenuecat"
  providerCustomerId String?
  providerSubId      String?
  plan               String    @default("free") // "free" | "pro_monthly" | "pro_yearly"
  status             String    @default("active") // "active" | "canceled" | "expired" | "past_due"
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([providerCustomerId])
  @@index([providerSubId])
}

model UsageRecord {
  id              String   @id @default(uuid())
  userId          String
  periodStart     DateTime
  documentUploads Int      @default(0)
  aiRequests      Int      @default(0)
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart])
  @@index([userId])
}

model Document {
  id           String   @id @default(uuid())
  userId       String
  folderId     String?
  title        String
  fileName     String
  fileUrl      String
  fileSize     Int
  pageCount    Int
  syncVersion  Int      @default(1)
  uploadedAt   DateTime @default(now())
  lastOpenedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder        Folder?        @relation(fields: [folderId], references: [id], onDelete: SetNull)
  annotations   Annotation[]
  aiContext     AIContext?
  conversations Conversation[]

  @@index([userId])
  @@index([folderId])
}

model Annotation {
  id           String   @id @default(uuid())
  documentId   String
  userId       String
  type         String // 'highlight', 'note', 'ai_explanation', 'drawing'
  pageNumber   Int
  color        String?
  position     Json // {x, y, width, height} or {strokes: [...]}
  selectedText String?
  content      String? // for notes/AI explanations
  syncVersion  Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
}

model AIContext {
  id            String   @id @default(uuid())
  documentId    String   @unique
  extractedText String   @db.Text
  chunkMetadata Json?
  createdAt     DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model Folder {
  id          String   @id @default(uuid())
  userId      String
  name        String
  color       String   @default("#3B82F6") // blue-500
  parentId    String?
  syncVersion Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Folder?    @relation("FolderNesting", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[]   @relation("FolderNesting")
  documents Document[]

  @@index([userId])
  @@index([parentId])
}

model Conversation {
  id          String   @id @default(uuid())
  userId      String
  documentId  String
  pageNumber  Int
  title       String
  screenshots Json     @default("[]") // array of {base64, pageNumber, region}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  document Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([documentId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  role           String   // 'user' or 'assistant'
  content        String   @db.Text
  screenshots    Json?    // optional screenshots for user messages
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}
